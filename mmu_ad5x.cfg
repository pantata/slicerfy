################################################################################
# Klipper Configuration for AD5X Multi-Material Unit (4-slot) with IFS
# 
# Tento soubor implementuje správu 4-slotové MMU přes IFS kontrolér s:
# - Nástrojovými makry (T0-T3)
# - Centrální logikou pro výměnu filamentu (MMU_CHANGE_TOOL)
# - Bezpečnostní kontrolami všech senzorů
# - Automatickou správou teploty a pozicování
# - Přímou integrací s IFS příkazy
#
# Hardwarová konfigurace je řízena přes IFS kontrolér
################################################################################

[save_variables]
filename: ~/klipper_config/mmu_variables.cfg

################################################################################
# 1. INICIALIZACE A PROMĚNNÉ
################################################################################

# Proměnné MMU - konfigurovatelné parametry
# Tyto proměnné se načítají na začátku každého makra
[gcode_macro _MMU_VARS]
variable_hotend_default_temp: 200          # Výchozí teplota trysky (°C)
variable_anti_ooze_temp_reduction: 30      # Snížení teploty při unloadu (°C)
variable_cut_speed: 600                    # Rychlost řezání (mm/min)
variable_cut_count: 3                      # Počet nárazu na páku
variable_cut_pause_ms: 100                 # Pauza mezi nárazy (ms)
variable_slot_count: 4                     # Počet slotů IFS (1-4)
gcode:

################################################################################
# 1a. KONFIGURACE SENZORŮ - CUSTOM ZMOD IFS MODULY
################################################################################
#
# Tato konfigurace používá CUSTOM senzory z IFS projektu (zmod_ifs_*),
# nikoliv standardní Klipper sensory!
#
# ============================================================================
# KRITICKÉ SENZORY (povinné pro bezpečnost)
# ============================================================================
#
# 1. Senzor v hlavi (extruderu) - detekce přítomnosti filamentu
#    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#    Typ: zmod_ifs_switch_sensor (custom modul!)
#    Název: head_switch_sensor (POVINNĚ!)
#    
#    Konfigurace:
#    [zmod_ifs_switch_sensor head_switch_sensor]
#    pause_on_runout: False
#    runout_gcode:
#        _MMU_RUNOUT_HEAD
#
# ============================================================================
# SENZORY FILAMENTU V IFS - detekce filamentu v jednotlivých portech
# ============================================================================
#
# 2. Motion sensory pro porty (1-4) - detekce pohybu
#    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#    Typ: zmod_ifs_motion_sensor
#    Názvy MUSÍ BÝT: _ifs_motion_sensor_1 až _ifs_motion_sensor_4
#    
#    Konfigurace pro každý port:
#    [zmod_ifs_motion_sensor _ifs_motion_sensor_1]
#    pause_on_runout: False
#    port: 1
#
#    [zmod_ifs_motion_sensor _ifs_motion_sensor_2]
#    pause_on_runout: False
#    port: 2
#
#    # Totéž pro porty 3 a 4
#
# 3. Switch sensory pro porty (1-4) - detekce přítomnosti
#    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#    Typ: zmod_ifs_switch_sensor s type:port
#    Názvy MUSÍ BÝT: _ifs_port_sensor_1 až _ifs_port_sensor_4
#    
#    Konfigurace:
#    [zmod_ifs_switch_sensor _ifs_port_sensor_1]
#    pause_on_runout: False
#    type: port
#    port: 1
#    runout_gcode:
#        _MMU_RUNOUT_SLOT SLOT=1
#    insert_gcode:
#        _MMU_INSERT_DETECTED SLOT=1
#
#    # Totéž pro porty 2, 3, 4 (změnit port: a SLOT=)
#
# ============================================================================
# DOPORUČENÁ KOMPLETNÍ KONFIGURACE
# ============================================================================
#
# Vložte do printer.cfg:
#
# [zmod_ifs_switch_sensor head_switch_sensor]
# pause_on_runout: False
# runout_gcode:
#     _MMU_RUNOUT_HEAD
#
# [zmod_ifs_motion_sensor _ifs_motion_sensor_1]
# pause_on_runout: False
# port: 1
#
# [zmod_ifs_motion_sensor _ifs_motion_sensor_2]
# pause_on_runout: False
# port: 2
#
# [zmod_ifs_motion_sensor _ifs_motion_sensor_3]
# pause_on_runout: False
# port: 3
#
# [zmod_ifs_motion_sensor _ifs_motion_sensor_4]
# pause_on_runout: False
# port: 4
#
# [zmod_ifs_switch_sensor _ifs_port_sensor_1]
# pause_on_runout: False
# type: port
# port: 1
# runout_gcode:
#     _MMU_RUNOUT_SLOT SLOT=1
# insert_gcode:
#     _MMU_INSERT_DETECTED SLOT=1
#
# [zmod_ifs_switch_sensor _ifs_port_sensor_2]
# pause_on_runout: False
# type: port
# port: 2
# runout_gcode:
#     _MMU_RUNOUT_SLOT SLOT=2
# insert_gcode:
#     _MMU_INSERT_DETECTED SLOT=2
#
# [zmod_ifs_switch_sensor _ifs_port_sensor_3]
# pause_on_runout: False
# type: port
# port: 3
# runout_gcode:
#     _MMU_RUNOUT_SLOT SLOT=3
# insert_gcode:
#     _MMU_INSERT_DETECTED SLOT=3
#
# [zmod_ifs_switch_sensor _ifs_port_sensor_4]
# pause_on_runout: False
# type: port
# port: 4
# runout_gcode:
#     _MMU_RUNOUT_SLOT SLOT=4
# insert_gcode:
#     _MMU_INSERT_DETECTED SLOT=4
#
# ============================================================================
# CHOVÁNÍ SENZORŮ (co se stane při detekci)
# ============================================================================
#
# Když head_switch_sensor detekuje RUNOUT (konec filamentu v hlavi):
#   → Volá se automaticky _MMU_RUNOUT_HEAD
#   → Kontrola, zda v IFS zbývá filament v aktivním slotu
#   → Pokud ano: zkusit pokračovat (měkký retrakt)
#   → Pokud ne: PAUSE s důvodem "runout_no_backup"
#
# Když _ifs_motion_sensor_X detekuje RUNOUT (konec v IFS):
#   → Volá se automaticky _MMU_RUNOUT_MOTION (je-li nakonfigurován)
#   → Automatický pokus vypotřebovat zbývající filament v hlavi
#   → PAUSE pro výměnu na nový filament
#
# Když _ifs_port_sensor_X detekuje INSERT:
#   → Volá se automaticky _MMU_INSERT_DETECTED SLOT=X
#   → Logování vložení filamentu
#
# ============================================================================
# POZNÁMKA: CUSTOM ZMOD MODULY
# ============================================================================
#
# Tyto senzory jsou CUSTOM moduly speciálně vyvinuté pro IFS kontrolér.
# Nejsou to standardní Klipper sensory (filament_motion_sensor atd)!
#
# Zmod moduly jsou v Pythonu a integrují se s IFS HW.
# Pro správu je potřeba:
# - zmod_ifs.py (HW vrstva)
# - zmod_ifs_motion_sensor.py (motion detekce)
# - zmod_ifs_switch_sensor.py (binární detekce)
#
################################################################################
    # Toto makro se neexekuje, slouží jen pro deklaraci proměnných

# Trvalé proměnné - uložené v souboru, přežívají restart Klipperu
[gcode_macro _MMU_INIT_VARIABLES]
description: Inicializace trvalých proměnných MMU
gcode:
    # Pouze proměnné, které musí přežít restart
    SAVE_VARIABLE VARIABLE=mmu_current_tool VALUE=-1
    SAVE_VARIABLE VARIABLE=mmu_state VALUE="idle"
    SAVE_VARIABLE VARIABLE=mmu_enabled VALUE=1
    # Stabilní pozice řezačky
    SAVE_VARIABLE VARIABLE=mmu_cut_x VALUE=-2.5
    SAVE_VARIABLE VARIABLE=mmu_cut_y VALUE=-7.5
    SAVE_VARIABLE VARIABLE=mmu_cut_z_down VALUE=-5
    SAVE_VARIABLE VARIABLE=mmu_cut_z_up VALUE=-2
    
    # Inicializace výchozích parametrů pro sloty 1-4
    SAVE_VARIABLE VARIABLE=slot_1_config VALUE='{"extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=slot_2_config VALUE='{"extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=slot_3_config VALUE='{"extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=slot_4_config VALUE='{"extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    
    # Inicializace konfigurací extruderů pro sloty 1-4
    SAVE_VARIABLE VARIABLE=extruder_1_config VALUE='{"slot": 1, "extruder": 1, "extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=extruder_2_config VALUE='{"slot": 2, "extruder": 2, "extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=extruder_3_config VALUE='{"slot": 3, "extruder": 3, "extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    SAVE_VARIABLE VARIABLE=extruder_4_config VALUE='{"slot": 4, "extruder": 4, "extruder_temp": 220, "filament_type": "PLA", "filament_colour": "#000000", "filament_unload_before_cutting": 0, "filament_unload_after_cutting": 5, "filament_unload_after_drop": 3, "filament_unload_speed": 600, "filament_load_speed": 300, "filament_tube_length": 1000, "filament_drop_length": 90, "filament_drop_length_add": 0, "filament_fan_speed": 102}'
    M118 "MMU proměnné inicializovány"

################################################################################
# 1b. MAKRA PRO SPRÁVU PARAMETRŮ SLOTŮ
################################################################################

[gcode_macro SET_EXTRUDER_PARAM]
description: Uložení parametrů filamentu pro konkrétní extruder (1-4)
params:
  SLOT: 1
  EXTRUDER:
  TEMP:
  FILAMENT_TYPE:
  FILAMENT_COLOUR:
  FILAMENT_UNLOAD_BEFORE_CUTTING:
  FILAMENT_UNLOAD_AFTER_CUTTING:
  FILAMENT_UNLOAD_AFTER_DROP:
  FILAMENT_UNLOAD_SPEED:
  FILAMENT_LOAD_SPEED:
  FILAMENT_TUBE_LENGTH:
  FILAMENT_DROP_LENGTH:
  FILAMENT_DROP_LENGTH_ADD:
  FILAMENT_FAN_SPEED:
gcode:
    {% set slot = params.SLOT|default(1)|int %}

    # Načtení stávající konfigurace pro daný slot
    {% set existing_config = (printer.save_variables.variables["extruder_" ~ slot ~ "_config"]|default('{}'))|fromjson %}

    # Použití stávajících hodnot jako defaultů, pokud parametr není předán.
    # Fallback na původní hardcoded hodnoty, pokud v configu nic není (první spuštění).
    {% set extruder = params.EXTRUDER|default(existing_config.get('extruder', slot))|int %}
    {% set extruder_temp = params.TEMP|default(existing_config.get('extruder_temp', 220))|int %}
    {% set filament_type = params.FILAMENT_TYPE|default(existing_config.get('filament_type', "PLA"))|string %}
    {% set filament_colour = params.FILAMENT_COLOUR|default(existing_config.get('filament_colour', "#000000"))|string %}
    {% set filament_unload_before_cutting = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(existing_config.get('filament_unload_before_cutting', 0))|float %}
    {% set filament_unload_after_cutting = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(existing_config.get('filament_unload_after_cutting', 5))|float %}
    {% set filament_unload_after_drop = params.FILAMENT_UNLOAD_AFTER_DROP|default(existing_config.get('filament_unload_after_drop', 3))|float %}
    {% set filament_unload_speed = params.FILAMENT_UNLOAD_SPEED|default(existing_config.get('filament_unload_speed', 600))|int %}
    {% set filament_load_speed = params.FILAMENT_LOAD_SPEED|default(existing_config.get('filament_load_speed', 300))|int %}
    {% set filament_tube_length = params.FILAMENT_TUBE_LENGTH|default(existing_config.get('filament_tube_length', 1000))|int %}
    {% set filament_drop_length = params.FILAMENT_DROP_LENGTH|default(existing_config.get('filament_drop_length', 90))|int %}
    {% set filament_drop_length_add = params.FILAMENT_DROP_LENGTH_ADD|default(existing_config.get('filament_drop_length_add', 0))|int %}
    {% set filament_fan_speed = params.FILAMENT_FAN_SPEED|default(existing_config.get('filament_fan_speed', 102))|int %}
    
    # Validace slotu
    {% if slot < 1 or slot > 4 %}
        { action_raise_error("Slot musí být 1-4") }
    {% endif %}
    
    # Vytvoření JSON s parametry
    {% set config = {
        "slot": slot,
        "extruder": extruder,
        "extruder_temp": extruder_temp,
        "filament_type": filament_type,
        "filament_colour": filament_colour,
        "filament_unload_before_cutting": filament_unload_before_cutting,
        "filament_unload_after_cutting": filament_unload_after_cutting,
        "filament_unload_after_drop": filament_unload_after_drop,
        "filament_unload_speed": filament_unload_speed,
        "filament_load_speed": filament_load_speed,
        "filament_tube_length": filament_tube_length,
        "filament_drop_length": filament_drop_length,
        "filament_drop_length_add": filament_drop_length_add,
        "filament_fan_speed": filament_fan_speed
    }|tojson %}
    
    # Uložení konfigurace extruderu
    SAVE_VARIABLE VARIABLE=extruder_{slot}_config VALUE='{config}'
    
    M118 "Parametry extruderu {slot} uloženy:"
    M118 "  Teplota: {extruder_temp}°C"
    M118 "  Typ filamentu: {filament_type}"
    M118 "  Barva: {filament_colour}"
    M118 "  Unload speed: {filament_unload_speed} mm/min"
    M118 "  Load speed: {filament_load_speed} mm/min"
    M118 "  Fan speed: {filament_fan_speed}"

[gcode_macro GET_SLOT_PARAM]
description: Načtení parametrů filamentu pro konkrétní slot a uložení do proměnných
params:
  SLOT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    
    # Validace slotu
    {% if slot < 1 or slot > 4 %}
        { action_raise_error("Slot musí být 1-4") }
    {% endif %}
    
    # Načtení uložené konfigurace
    {% set slot_config = printer.save_variables.variables["slot_" ~ slot ~ "_config"]|default('{}') %}
    
    {% if slot_config == '{}' %}
        M118 "UPOZORNĚNÍ: Pro slot {slot} nejsou uloženy žádné parametry"
    {% else %}
        # Parsování JSON konfigurace
        {% set config = slot_config|fromjson %}
        
        M118 "Parametry slotu {slot}:"
        M118 "  Teplota: {config.extruder_temp}°C"
        M118 "  Typ filamentu: {config.filament_type}"
        M118 "  Barva: {config.filament_colour|default('#000000')}"
        M118 "  Unload před řezáním: {config.filament_unload_before_cutting} mm"
        M118 "  Unload po řezání: {config.filament_unload_after_cutting} mm"
        M118 "  Unload po pádu: {config.filament_unload_after_drop} mm"
        M118 "  Unload speed: {config.filament_unload_speed} mm/min"
        M118 "  Load speed: {config.filament_load_speed} mm/min"
        M118 "  Délka trubky: {config.filament_tube_length} mm"
        M118 "  Délka pádu: {config.filament_drop_length} mm"
        M118 "  Přidaná délka pádu: {config.filament_drop_length_add} mm"
        M118 "  Fan speed: {config.filament_fan_speed}"
    {% endif %}

[gcode_macro SHOW_ALL_SLOT_PARAMS]
description: Zobrazení parametrů všech slotů
gcode:
    M118 "===== KONFIGURАЦИЯ VŠECH SLOTŮ ====="
    
    {% for slot_num in range(1, 5) %}
        GET_SLOT_PARAM SLOT={slot_num}
        M118 ""
    {% endfor %}

################################################################################
# 2. POMOCNÁ MAKRA - OBALUJÍCÍ VRSTVA PRO IFS PŘÍKAZY
################################################################################

[gcode_macro _MMU_INSERT_FILAMENT]
description: Zavedení filamentu do IFS ze slotu (IFS_F10 wrapper)
params:
  SLOT: 1
  LEN: 90
  SPEED: 1200
  WAIT: 1
  CHECK: 0
  SLEEP: 0
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    {% set len = params.LEN|default(90)|int %}
    {% set speed = params.SPEED|default(1200)|int %}
    {% set wait = params.WAIT|default(1)|int %}
    {% set check = params.CHECK|default(0)|int %}
    {% set sleep = params.SLEEP|default(0)|int %}
    
    {% if slot < 1 or slot > 4 %}
        { action_raise_error("Slot musí být 1-4") }
    {% endif %}
    
    M118 "Zavádím filament do IFS ze slotu {slot} (len={len}mm, speed={speed}mm/min)..."
    # IFS_F10 - Insert filament
    IFS_F10 PRUTOK={slot} LEN={len} SPEED={speed} WAIT={wait} CHECK={check} SLEEP={sleep}
    M118 "Filament zaveden do IFS"

[gcode_macro _MMU_REMOVE_FILAMENT]
description: Vytažení filamentu z IFS (IFS_F11 wrapper)
params:
  SLOT: 1
  LEN: 90
  SPEED: 1200
  WAIT: 1
  CHECK: 0
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    {% set len = params.LEN|default(90)|int %}
    {% set speed = params.SPEED|default(1200)|int %}
    {% set wait = params.WAIT|default(1)|int %}
    {% set check = params.CHECK|default(0)|int %}
    
    M118 "Vytahuji filament z IFS ze slotu {slot} (len={len}mm, speed={speed}mm/min)..."
    # IFS_F11 - Remove filament
    IFS_F11 PRUTOK={slot} LEN={len} SPEED={speed} WAIT={wait} CHECK={check}
    M118 "Filament vybrán z IFS"

[gcode_macro _MMU_DRIVER_RESET]
description: Reset IFS řídící jednotky (IFS_F15 wrapper)
gcode:
    M118 "Resetuji IFS řídící jednotku..."
    # IFS_F15 - Reset driver
    IFS_F15
    M118 "Řídící jednotka resetována"

[gcode_macro _MMU_GET_STATUS]
description: Zjistit stav IFS (IFS_F13 wrapper)
gcode:
    M118 "Zjišťuji stav IFS..."
    # IFS_F13 - Get IFS state
    IFS_F13
    M118 "Stav IFS zjištěn"

[gcode_macro _MMU_PURGE_ALL]
description: Čištění filamentu všude v IFS (IFS_F18 wrapper)
params:
  WAIT: 1
gcode:
    {% set wait = params.WAIT|default(1)|int %}
    
    M118 "Čistím filament v celé IFS..."
    # IFS_F18 - Filament purge everywhere
    IFS_F18 WAIT={wait}
    M118 "Čištění dokončeno"

[gcode_macro _MMU_MARK_INSERTED]
description: Označit filament jako zavedený (IFS_F23 wrapper)
params:
  SLOT: 1
  WAIT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    {% set wait = params.WAIT|default(1)|int %}
    
    M118 "Označuji filament jako zavedený (slot {slot})..."
    # IFS_F23 - Mark filament as inserted
    IFS_F23 PRUTOK={slot} WAIT={wait}
[gcode_macro _MMU_FILAMENT_CLAMP]
description: Upnutí filamentu (IFS_F24 wrapper)
params:
  SLOT: 1
  WAIT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    {% set wait = params.WAIT|default(1)|int %}
    
    M118 "Upínám filament (slot {slot})..."
    # IFS_F24 - Filament clamp
    IFS_F24 PRUTOK={slot} WAIT={wait}

[gcode_macro _MMU_FILAMENT_PURGE]
description: Čištění filamentu (IFS_F39 wrapper)
params:
  SLOT: 1
  WAIT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    {% set wait = params.WAIT|default(1)|int %}
    
    M118 "Čistím filament (slot {slot})..."
    # IFS_F39 - Filament purge
    IFS_F39 PRUTOK={slot} WAIT={wait}
    M118 "Čištění filamentu dokončeno"

[gcode_macro _MMU_STOP_FEED]
description: Zastavit podávání filamentu (IFS_F112 wrapper)
gcode:
    M118 "Zastavuji podávání filamentu..."
    # IFS_F112 - Stop filament feed
    IFS_F112
    M118 "Podávání zastaveno"

[gcode_macro _MMU_PURGE_TO_EXTRUDER]
description: Čistění filamentu z IFS do extruderu (PURGE_PRUTOK_IFS wrapper)
params:
  LENGTH: 100
gcode:
    {% set length = params.LENGTH|default(100)|int %}
    M118 "Čistím filament z IFS do extruderu ({length}mm)..."
    # PURGE_PRUTOK_IFS - Purge filament from IFS to extruder
    PURGE_PRUTOK_IFS
    M118 "Čištění do extruderu dokončeno"

[gcode_macro _MMU_REMOVE_BY_SLOT]
description: Odstranit filament podle čísla slotu (REMOVE_PRUTOK_IFS wrapper)
params:
  SLOT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    M118 "Odstraňuji filament ze slotu {slot}..."
    # REMOVE_PRUTOK_IFS - Removes filament by filament number
    REMOVE_PRUTOK_IFS
    M118 "Filament ze slotu {slot} odstraněn"

[gcode_macro _MMU_INSERT_BY_SLOT]
description: Zavedení filamentu podle čísla slotu - načítá parametry z configu slotu (_INSERT_PRUTOK_IFS wrapper)
params:
  SLOT: 1
  TEMP: 0
  NEED_STOP: 0
  TRASH: 0
  FILAMENT_TYPE: ""
  FILAMENT_UNLOAD_BEFORE_CUTTING: -1
  FILAMENT_UNLOAD_AFTER_CUTTING: -1
  FILAMENT_UNLOAD_AFTER_DROP: -1
  FILAMENT_UNLOAD_SPEED: 0
  FILAMENT_LOAD_SPEED: 0
  FILAMENT_TUBE_LENGTH: 0
  FILAMENT_DROP_LENGTH: 0
  FILAMENT_DROP_LENGTH_ADD: 0
  FILAMENT_FAN_SPEED: 0
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    
    # Validace slotu
    {% if slot < 1 or slot > 4 %}
        { action_raise_error("Slot musí být 1-4") }
    {% endif %}
    
    # Načtení uložené konfigurace pro slot
    {% set slot_config_str = printer.save_variables.variables["slot_" ~ slot ~ "_config"]|default('{}') %}
    {% set slot_config = slot_config_str|fromjson %}
    
    # Extrahování parametrů z configu s možností override z params
    {% set extruder_temp = (params.TEMP|default(0)|int) if params.TEMP|default(0)|int > 0 else slot_config.get("extruder_temp", 220)|int %}
    {% set need_stop = (params.NEED_STOP|default(0)|int) if params.NEED_STOP|default(0)|int != 0 else 1 %}
    {% set trash = (params.TRASH|default(0)|int) if params.TRASH|default(0)|int != 0 else 0 %}
    {% set filament_type = params.FILAMENT_TYPE if params.FILAMENT_TYPE|default("")|length > 0 else slot_config.get("filament_type", "PLA") %}
    {% set filament_unload_before_cutting = (params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(-1)|float) if params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(-1)|float >= 0 else slot_config.get("filament_unload_before_cutting", 0)|float %}
    {% set filament_unload_after_cutting = (params.FILAMENT_UNLOAD_AFTER_CUTTING|default(-1)|float) if params.FILAMENT_UNLOAD_AFTER_CUTTING|default(-1)|float >= 0 else slot_config.get("filament_unload_after_cutting", 5)|float %}
    {% set filament_unload_after_drop = (params.FILAMENT_UNLOAD_AFTER_DROP|default(-1)|float) if params.FILAMENT_UNLOAD_AFTER_DROP|default(-1)|float >= 0 else slot_config.get("filament_unload_after_drop", 3)|float %}
    {% set filament_unload_speed = (params.FILAMENT_UNLOAD_SPEED|default(0)|int) if params.FILAMENT_UNLOAD_SPEED|default(0)|int > 0 else slot_config.get("filament_unload_speed", 600)|int %}
    {% set filament_load_speed = (params.FILAMENT_LOAD_SPEED|default(0)|int) if params.FILAMENT_LOAD_SPEED|default(0)|int > 0 else slot_config.get("filament_load_speed", 300)|int %}
    {% set filament_tube_length = (params.FILAMENT_TUBE_LENGTH|default(0)|int) if params.FILAMENT_TUBE_LENGTH|default(0)|int > 0 else slot_config.get("filament_tube_length", 1000)|int %}
    {% set filament_drop_length = (params.FILAMENT_DROP_LENGTH|default(0)|int) if params.FILAMENT_DROP_LENGTH|default(0)|int > 0 else slot_config.get("filament_drop_length", 90)|int %}
    {% set filament_drop_length_add = (params.FILAMENT_DROP_LENGTH_ADD|default(0)|int) if params.FILAMENT_DROP_LENGTH_ADD|default(0)|int != 0 else slot_config.get("filament_drop_length_add", 0)|int %}
    {% set filament_fan_speed = (params.FILAMENT_FAN_SPEED|default(0)|int) if params.FILAMENT_FAN_SPEED|default(0)|int > 0 else slot_config.get("filament_fan_speed", 102)|int %}

    M118 "Zavádím filament ze slotu {slot}..."
    M118 "Parametry: TEMP={extruder_temp}°C, TYPE={filament_type}, UNLOAD_SPEED={filament_unload_speed}mm/min, LOAD_SPEED={filament_load_speed}mm/min"
    
    # _INSERT_PRUTOK_IFS - Insert filament into IFS by filament number
    _INSERT_PRUTOK_IFS PRUTOK={slot} TEMP={extruder_temp} NEED_STOP={need_stop} TRASH={trash} FILAMENT_TYPE={filament_type} FILAMENT_UNLOAD_BEFORE_CUTTING={filament_unload_before_cutting} FILAMENT_UNLOAD_AFTER_CUTTING={filament_unload_after_cutting} FILAMENT_UNLOAD_AFTER_DROP={filament_unload_after_drop} FILAMENT_UNLOAD_SPEED={filament_unload_speed} FILAMENT_LOAD_SPEED={filament_load_speed} FILAMENT_TUBE_LENGTH={filament_tube_length} FILAMENT_DROP_LENGTH={filament_drop_length} FILAMENT_DROP_LENGTH_ADD={filament_drop_length_add} FILAMENT_FAN_SPEED={filament_fan_speed}
    M118 "Filament ze slotu {slot} zaveden"

[gcode_macro _MMU_SET_CURRENT_TOOL]
description: Nastavit aktivní filament v Klipperu (SET_CURRENT_PRUTOK wrapper)
params:
  SLOT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    M118 "Nastavuji aktuální filament na slot {slot}..."
    # SET_CURRENT_PRUTOK - Tell klipper which filament is currently active
    SET_CURRENT_PRUTOK
    M118 "Aktuální filament nastaven na slot {slot}"

[gcode_macro _MMU_LOAD_ANALOG_ROD]
description: Načíst analogický filament (ANALOG_PRUTOK wrapper)
gcode:
    M118 "Načítám analogický filament..."
    # ANALOG_PRUTOK - Load an analog rod
    ANALOG_PRUTOK
    M118 "Analogický filament načten"

[gcode_macro _MMU_CHECK_MOTION]
description: Kontrola pohybu/stavu filamentu (IFS_MOTION wrapper)
gcode:
    M118 "Kontroluji pohyb filamentu..."
    # IFS_MOTION - Check if filament has stopped or run out
    IFS_MOTION
    M118 "Kontrola pohybu dokončena"

[gcode_macro _MMU_CUT]
description: Pohyb k řezačce a řezání filamentu nárazy na páku
gcode:
    {% set cut_x = printer.save_variables.variables.mmu_cut_x|default(-2.5)|float %}
    {% set cut_y = printer.save_variables.variables.mmu_cut_y|default(-7.5)|float %}
    {% set cut_z_down = printer.save_variables.variables.mmu_cut_z_down|default(-5)|int %}
    {% set cut_z_up = printer.save_variables.variables.mmu_cut_z_up|default(-2)|int %}
    {% set cut_speed = printer["gcode_macro _MMU_VARS"].variable_cut_speed|int %}
    {% set cut_count = printer["gcode_macro _MMU_VARS"].variable_cut_count|int %}
    {% set cut_pause = printer["gcode_macro _MMU_VARS"].variable_cut_pause_ms|int %}
    
    M118 "Navíjím hlavu k řezačce..."
    # Pohyb hlavy k řezačce na pozici řezu
    G0 X{cut_x} Y{cut_y} F3000
    G4 P200  # Čekání na stabilizaci
    
    M118 "Řežu filament nárazy na páku ({cut_count}x)..."
    # Opakované nárazy na páku
    {% for i in range(cut_count) %}
        G0 Z{cut_z_down} F{cut_speed}
        G4 P{cut_pause}
        G0 Z{cut_z_up} F{cut_speed}
        G4 P{cut_pause}
    {% endfor %}
    
    M118 "Řezání dokončeno"

################################################################################
# 3. MAKRA PRO SPRÁVU NÁSTROJŮ
################################################################################

[gcode_macro T0]
description: Rezervováno pro custom G-code (pradasa slicer) - nepoužívat přímo
gcode:
    # Toto makro je voláno z custom G-code v prusasliceru
    # Parametry jsou předány přes MMU_CHANGE_TOOL
    # Viz MMU_CHANGE_TOOL pro detaily

[gcode_macro T1]
description: Rezervováno pro custom G-code (pradasa slicer) - nepoužívat přímo
gcode:
    # Toto makro je voláno z custom G-code v prusasliceru
    # Parametry jsou předány přes MMU_CHANGE_TOOL
    # Viz MMU_CHANGE_TOOL pro detaily

[gcode_macro T2]
description: Rezervováno pro custom G-code (pradasa slicer) - nepoužívat přímo
gcode:
    # Toto makro je voláno z custom G-code v prusasliceru
    # Parametry jsou předány přes MMU_CHANGE_TOOL
    # Viz MMU_CHANGE_TOOL pro detaily

[gcode_macro T3]
description: Rezervováno pro custom G-code (pradasa slicer) - nepoužívat přímo
gcode:
    # Toto makro je voláno z custom G-code v prusasliceru
    # Parametry jsou předány přes MMU_CHANGE_TOOL
    # Viz MMU_CHANGE_TOOL pro detaily

################################################################################
# 4. CENTRÁLNÍ MAKRO PRO VÝMĚNU NÁSTROJŮ - PŘES IFS
################################################################################

[gcode_macro MMU_CHANGE_TOOL]
description: Centrální makro pro výměnu filamentu s parametry z prusssliceru
params:
  TOOL: 1
  HOTEND_TEMP: 0
  INSERT_LEN: 0
  INSERT_SPEED: 0
  REMOVE_LEN: 0
  REMOVE_SPEED: 0
gcode:
    {% set current_tool = printer.save_variables.variables.mmu_current_tool|default(-1)|int %}
    {% set new_tool = params.TOOL|default(1)|int %}
    
    # Teplota extruderu - pokud není specifikovaná, použij cílovou teplotu nebo default
    {% set param_hotend_temp = params.HOTEND_TEMP|default(0)|int %}
    {% set hotend_temp = param_hotend_temp if param_hotend_temp > 0 else printer.extruder.target_temperature|default(printer["gcode_macro _MMU_VARS"].variable_hotend_default_temp)|int %}
    
    # Parametry pro zavedení filamentu (IFS_F10)
    {% set insert_len = params.INSERT_LEN|default(0)|int %}
    {% set insert_len = 90 if insert_len == 0 else insert_len %}
    {% set insert_speed = params.INSERT_SPEED|default(0)|int %}
    {% set insert_speed = 1200 if insert_speed == 0 else insert_speed %}
    
    # Parametry pro vytažení filamentu (IFS_F11)
    {% set remove_len = params.REMOVE_LEN|default(0)|int %}
    {% set remove_len = 90 if remove_len == 0 else remove_len %}
    {% set remove_speed = params.REMOVE_SPEED|default(0)|int %}
    {% set remove_speed = 1200 if remove_speed == 0 else remove_speed %}
    
    {% set anti_ooze_reduction = printer["gcode_macro _MMU_VARS"].variable_anti_ooze_temp_reduction|int %}
    
    # Validace nástroje
    {% if new_tool < 1 or new_tool > 4 %}
        { action_raise_error("Nástroj musí být 1-4") }
    {% endif %}
    
    # Zkontroluj, zda je MMU povolena
    {% if printer.save_variables.variables.mmu_enabled|default(1)|int == 0 %}
        { action_raise_error("MMU je vypnutá") }
    {% endif %}
    
    M118 "Výměna nástroje: {current_tool} -> {new_tool} (HOTEND={hotend_temp}°C)"
    M118 "Parametry: INSERT L{insert_len}mm@{insert_speed}mm/min, REMOVE L{remove_len}mm@{remove_speed}mm/min"
    
    # Pokud je stejný nástroj, nic se neděje
    {% if current_tool == new_tool %}
        M118 "Nástroj {new_tool} je již vybrán"
        { action_exit_gcode_on_error }
    {% endif %}
    
    # ========== FÁZE 1: UNLOAD (Vytažení) ==========
    M118 "Fáze 1: UNLOAD z slotu {current_tool}"
    
    {% if current_tool >= 0 %}
        # Hlava obsahuje filament - je třeba jej vytáhnout
        
        # 1a. Retrakt (-20mm)
        M118 "Retrakce filamentu..."
        G91
        G0 E-20 F300
        G90
        
        # 1b. Sníž teplotu o 30°C (anti-ooze)
        M118 "Snižuji teplotu pro anti-ooze..."
        {% set ooze_temp = hotend_temp - anti_ooze_reduction %}
        M104 S{ooze_temp}
        
        # 1c. Řezání filamentu
        M118 "Řežu filament..."
        _MMU_CUT
        
        # 1d. Zavolej IFS funkci pro vytažení filamentu s custom parametry
        M118 "Vytahuji filament z IFS (L{remove_len}mm@{remove_speed}mm/min)..."
        _MMU_REMOVE_FILAMENT SLOT={current_tool} LEN={remove_len} SPEED={remove_speed}
        
        # 1e. Ověření vyjmutí
        M118 "Ověřuji vyjmutí filamentu..."
        _MMU_VERIFY_UNLOAD
        
        M118 "Unload dokončen"
    {% else %}
        M118 "Hlava je prázdná, přeskakuji unload"
    {% endif %}
    
    # ========== FÁZE 2: SELECT (Výběr) ==========
    M118 "Fáze 2: SELECT slot {new_tool}"
    
    # Zavolej IFS funkci pro zavedení filamentu
    _MMU_INSERT_BY_SLOT SLOT={new_tool}
    
    G4 P500  # Krátké čekání na stabilizaci
    M118 "Slot {new_tool} vybrán"
    
    # ========== FÁZE 3: LOAD (Zavedení) ==========
    M118 "Fáze 3: LOAD filamentu do extruderu"
    
    # 3a. Začni nahřívat na cílovou teplotu (neblokující)
    M118 "Zahřívám trysku na {hotend_temp}°C..."
    M104 S{hotend_temp}
    
    # 3b. Zavedení filamentu z IFS do extruderu s custom parametry (čistění)
    M118 "Čistím filament z IFS do extruderu (L{insert_len}mm@{insert_speed}mm/min)..."
    _MMU_INSERT_FILAMENT SLOT={new_tool} LEN={insert_len} SPEED={insert_speed}
    
    # 3c. Čekej na dosažení cílové teploty
    M118 "Čekám na teplotu {hotend_temp}°C..."
    M109 S{hotend_temp}
    
    # 3d. Označení filamentu jako zavědeného
    M118 "Označuji filament jako zavvedený..."
    _MMU_MARK_INSERTED SLOT={new_tool} WAIT=1
    
    # 3e. Bezpečnostní kontrola - zavolej kontrolu pohybu
    M118 "Kontroluji pohyb filamentu..."
    _MMU_CHECK_MOTION
    
    # 3f. Ověření zavedení
    M118 "Ověřuji zavedení filamentu..."
    _MMU_VERIFY_LOAD
    
    # Uložení aktuálního nástroje
    SAVE_VARIABLE VARIABLE=mmu_current_tool VALUE={new_tool}
    SAVE_VARIABLE VARIABLE=mmu_state VALUE="idle"
    _MMU_SET_CURRENT_TOOL SLOT={new_tool}
    
    M118 "Výměna nástroje dokončena: Slot {new_tool}"

################################################################################
# 5. MAKRO START_PRINT
################################################################################

[gcode_macro START_PRINT]
description: Příprava tiskárny - inicializace MMU a zavedení prvního filamentu
params:
  INITIAL_TOOL: 1
  NOZZLE_TEMP: 200
  BED_TEMP: 60
gcode:
    {% set initial_tool = params.INITIAL_TOOL|default(1)|int %}
    {% set nozzle_temp = params.NOZZLE_TEMP|default(200)|int %}
    {% set bed_temp = params.BED_TEMP|default(60)|int %}
    
    M118 "START_PRINT - Příprava tiskárny"
    M118 "Parametry: TOOL={initial_tool}, NOZZLE={nozzle_temp}°C, BED={bed_temp}°C"
    
    # ========== FÁZE 1: Zahřívání ==========
    # Spustit zahřívání bez čekání (paralelně se zbytkem přípravy)
    M140 S{bed_temp}
    M104 S{nozzle_temp}
    
    # ========== FÁZE 2: Inicializace tiskárny ==========
    # Domů
    M118 "Naježdím domů (G28)..."
    G28 X Y
    
    # Inicialiace MMU proměnných
    M118 "Inicializuji MMU..."
    _MMU_INIT_VARIABLES
    
    # Reset IFS řídící jednotky
    M118 "Resetuji IFS kontrolér..."
    _MMU_DRIVER_RESET
    
    # ========== FÁZE 3: Čekání na teploty ==========
    M118 "Čekám na dosažení teplot..."
    M190 S{bed_temp}  # Čekej na tisk. plochu
    M109 S{nozzle_temp}  # Čekej na trysku
    
    # ========== FÁZE 4: Zavedení prvního filamentu ==========
    M118 "Zavedení filamentu ze slotu {initial_tool}..."
    
    # Pokud je v hlavě filament, zkus ho detekovat a použít správný slot
    # OPCIONÁLNĚ - pokud chcete auto-detect, odkomentujte:
    # _MMU_DETECT_FILAMENT_IN_HEAD
    
    # Zavedení filamentu do IFS
    _MMU_INSERT_BY_SLOT SLOT={initial_tool}
    
    # Čistění do extruderu
    _MMU_PURGE_TO_EXTRUDER LENGTH=100
    
    # Označení filamentu
    _MMU_MARK_INSERTED SLOT={initial_tool}
    
    # Ověření zavedení
    _MMU_VERIFY_LOAD
    
    # ========== FÁZE 5: Finální příprava ==========
    # Uložení aktuálního nástroje
    SAVE_VARIABLE VARIABLE=mmu_current_tool VALUE={initial_tool}
    SAVE_VARIABLE VARIABLE=mmu_state VALUE="idle"
    _MMU_SET_CURRENT_TOOL SLOT={initial_tool}
    
    # Reset GCODE souřadnic
    G92 X0 Y0 Z0 E0
    
    # Povolení senzorů na konci (pokud existují)
    M118 "Povoluju senzory..."
    # SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=1
    
    M118 "Příprava tiskárny HOTOVA - Tisk začíná"

################################################################################
# 6. DODATKOVÁ MAKRA PRO DIAGNOSTIKU A ÚDRŽBU
################################################################################

[gcode_macro MMU_STATUS]
description: Výpis aktuálního stavu MMU a IFS
gcode:
    {% set current_tool = printer.save_variables.variables.mmu_current_tool|default(-1)|int %}
    {% set mmu_state = printer.save_variables.variables.mmu_state|default("unknown") %}
    
    M118 "===== MMU STATUS ====="
    M118 "Aktuální nástroj (slot): {current_tool}"
    M118 "Stav MMU: {mmu_state}"
    M118 "Teplota trysky: {printer.extruder.temperature|int}°C / {printer.extruder.target_temperature|int}°C"
    M118 "Zjišťuji stav IFS..."
    _MMU_GET_STATUS

[gcode_macro MMU_ENABLE]
description: Povolení MMU
gcode:
    SAVE_VARIABLE VARIABLE=mmu_enabled VALUE=1
    M118 "MMU je povolena"

[gcode_macro MMU_DISABLE]
description: Zakázání MMU
gcode:
    SAVE_VARIABLE VARIABLE=mmu_enabled VALUE=0
    M118 "MMU je zakázána"

[gcode_macro MMU_RESET]
description: Reset stavu MMU a IFS jednotky
gcode:
    SAVE_VARIABLE VARIABLE=mmu_current_tool VALUE=-1
    SAVE_VARIABLE VARIABLE=mmu_state VALUE="idle"
    M118 "Resetuji MMU..."
    _MMU_DRIVER_RESET
    M118 "MMU resetována"

[gcode_macro MMU_EMERGENCY_STOP]
description: Nouzové zastavení - vypnutí pohonu filamentu
gcode:
    M118 "NOUZOVÉ ZASTAVENÍ - Zastavuji podávání filamentu"
    _MMU_STOP_FEED
    M118 "Filament zastaven"

[gcode_macro MMU_PURGE_FILAMENT]
description: Čistění filamentu v celé IFS
gcode:
    M118 "Zahajuji čistění filamentu..."
    _MMU_PURGE_ALL
    M118 "Čistění dokončeno"

################################################################################
# 7. POMOCNÁ MAKRA PRO START_PRINT
################################################################################

[gcode_macro _MMU_START_PARK]
description: Parkování hlavy na bezpečné místo během START_PRINT
gcode:
    M118 "Parkuji hlavu..."
    # Přizpůsob souřadnice dle vaší tiskárny
    G0 X10 Y10 Z50 F3000

[gcode_macro _MMU_ENABLE_SENSORS]
description: Povolení všech filamentových senzorů
gcode:
    M118 "Povoluju filamentové senzory..."
    # Tato makra se zavolají, když budou senzory nakonfigurované
    # SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=1
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_0 ENABLE=1
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_1 ENABLE=1
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_2 ENABLE=1
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_3 ENABLE=1

[gcode_macro _MMU_DISABLE_SENSORS]
description: Zakázání všech filamentových senzorů
gcode:
    M118 "Zakazuji filamentové senzory..."
    # SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=0
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_0 ENABLE=0
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_1 ENABLE=0
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_2 ENABLE=0
    # SET_FILAMENT_SENSOR SENSOR=mmu_sensor_3 ENABLE=0

################################################################################
# 8. MAKRA PRO OBSLUHU SENZORŮ A DETEKCI FILAMENTU
################################################################################

# Detekce filamentu v hlavě při spuštění
[gcode_macro _MMU_DETECT_FILAMENT_IN_HEAD]
description: Detekce, který filament je v hlavě při spuštění (vrací -1 pokud nic)
gcode:
    M118 "Detekuji filament v hlavě..."
    
    # Nejprve zkontroluj, zda je v hlavě vůbec nějaký filament
    {% set has_head_sensor = "zmod_ifs_switch_sensor head_switch_sensor" in printer %}
    
    {% if not has_head_sensor %}
        M118 "UPOZORNĚNÍ: head_switch_sensor není nakonfigurován - přeskakuji detekci"
        SAVE_VARIABLE VARIABLE=mmu_detected_slot VALUE="-1"
    {% else %}
        # Zkontroluj, zda je filament v hlavi
        {% set filament_present = printer["zmod_ifs_switch_sensor head_switch_sensor"].filament_detected %}
        
        {% if not filament_present %}
            M118 "V hlavě není filament - detekce přeskočena"
            SAVE_VARIABLE VARIABLE=mmu_detected_slot VALUE="-1"
        {% else %}
            M118 "V hlavě je filament - určuji z kterého slotu..."
            
            # Je filament? Pokus se posunout a detekuj který senzor hlásí pohyb
            # Toto funguje protože každý slot (1-4) má svůj motion sensor: _ifs_motion_sensor_1 až _ifs_motion_sensor_4
            
            {% set detected_slot = -1 %}
            
            # Prehřej extruder na 200°C pro detekci
            M104 S200
            
            # Testuj pohyb filamentu při malém posunu
            # Zpomalíme na F100 a měřime, kterou senzory reportují pohyb
            # První pohyb ZPĚT aby se předešlo ozingu
            G91
            G0 E-5 F100  # Malý pohyb ZPĚT (5mm) - bez ozingu
            G4 P300     # Čekání, aby se zaregistrovalo
            G90
            
            # Nyní zkontroluj, které motion sensory reportují aktivitu
            # Pohybový senzor vygeneruje event, pokud se filament pohybuje přes něj
            
            {% for slot in range(1, 5) %}
                {% set motion_sensor_name = "zmod_ifs_motion_sensor _ifs_motion_sensor_" ~ slot %}
                
                {% if motion_sensor_name in printer %}
                    {% if printer[motion_sensor_name].filament_detected %}
                        M118 "Detekován pohyb ze slotu {slot} (motion sensor)"
                        {% set detected_slot = slot %}
                        {% break %}
                    {% endif %}
                {% endif %}
            {% endfor %}
                        
            {% if detected_slot > 0 %}
                M118 "DETEKCE OK: Filament ze slotu {detected_slot}"
                SAVE_VARIABLE VARIABLE=mmu_detected_slot VALUE="{detected_slot}"
                SAVE_VARIABLE VARIABLE=mmu_current_tool VALUE="{detected_slot}"
            {% else %}
                M118 "UPOZORNĚNÍ: Filament není v senzorech - neznámého původu"
                SAVE_VARIABLE VARIABLE=mmu_detected_slot VALUE="-1"
            {% endif %}
        {% endif %}
    {% endif %}

# Obsluha runoutu během tisku - konec filamentu v hlavi
[gcode_macro _MMU_RUNOUT_HEAD]
description: Reakce na konec filamentu v hlavi během tisku (z head_switch_sensor)
gcode:
    # DŮLEŽITÉ: Toto je vyvolávno sensorem automaticky
    # Sensor config musí mít: runout_gcode = _MMU_RUNOUT_HEAD
    
    {% if printer.print_stats.state == "printing" %}
        M118 "!!! RUNOUT ALERT: Filament v hlavi vypršel !!!"
        
        # Disabluj senzor, aby se nevojal znovu
        SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=0
        
        # Kontrola: je v IFS ještě filament v aktuálním slotu?
        {% set current_tool = printer.save_variables.variables.mmu_current_tool|default(-1)|int %}
        
        {% if current_tool >= 1 %}
            # Zkus se podívat, zda motion sensor v IFS hlásí filament
            {% set motion_sensor_name = "zmod_ifs_motion_sensor _ifs_motion_sensor_" ~ current_tool %}
            {% set has_backup = motion_sensor_name in printer and printer[motion_sensor_name].filament_detected %}
            
            {% if has_backup %}
                M118 "Ve slotu {current_tool} je ještě filament - pokouším se jej vést..."
                
                # Zkus částečně vybrat filament (např. měkký retrakt)
                G91
                G0 E-2 F300  # Malý retrakt
                G90
                
                G4 P500  # Čekání
                
                # Znovu povoluj senzor a pokračuj
                SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
                
                M118 "Pokus o nový filament ze slotu {current_tool} - pokračuji v tisku"
                # Tisk pokračuje
                
            {% else %}
                # V IFS není filament - musíme pozastavit tisk
                M118 "Ve slotu {current_tool} není náhradní filament - pozastavuji tisk"
                PAUSE REASON="runout_no_backup"
            {% endif %}
        {% else %}
            # Neznám aktuální slot
            M118 "Filament vypršel - neznámý slot - pozastavuji tisk"
            PAUSE REASON="runout_unknown_slot"
        {% endif %}
    {% else %}
        # Tisk není aktivní - ignor
        M118 "RUNOUT detekován mimo tisk - ignoruji"
    {% endif %}

# Obsluha runoutu v IFS jednotce během tisku
[gcode_macro _MMU_RUNOUT_MOTION]
description: Reakce na konec filamentu detekovaný pohybovým sensorem v IFS
gcode:
    # DŮLEŽITÉ: Toto je vyvolano motion sensorem v IFS
    # Sensor config musí mít: runout_gcode = _MMU_RUNOUT_MOTION
    # (Zatím se obvykle konfiguruje jen v _ifs_motion_sensor_X)
    
    {% if printer.print_stats.state == "printing" %}
        M118 "!!! RUNOUT ALERT: Filament v IFS vypršel (motion sensor) !!!"
        
        # Motion sensor v IFS hlásí, že filament skončil
        {% set current_tool = printer.save_variables.variables.mmu_current_tool|default(-1)|int %}
        
        # Pokus se vypotřebovat zbývající filament v hlavi
        M118 "Zkouším vypotřebovat zbývající filament v hlavi..."
        
        # Ověř, že máme filament v hlavi
        {% set has_head_sensor = "zmod_ifs_switch_sensor head_switch_sensor" in printer %}
        {% if has_head_sensor and not printer["zmod_ifs_switch_sensor head_switch_sensor"].filament_detected %}
            M118 "V hlavi není filament - pozastavuji tisk"
            PAUSE REASON="ifs_runout_no_head_filament"
        {% else %}
            # Máme co čistit - zavolej CONSUME
            _MMU_CONSUME_FILAMENT ITERATIONS=10 LENGTH=8 SPEED=80
            
            # Po čistění - pozastav tisk, aby se mohl vybrat nový filament
            M118 "Zbývající filament vyvíjený - pozastavuji tisk pro změnu"
            PAUSE REASON="ifs_runout_consumed"
        {% endif %}
    {% else %}
        M118 "RUNOUT v IFS detekován mimo tisk - ignoruji"
    {% endif %}

# Obsluha detekce filamentu v jednotlivých slotech
[gcode_macro _MMU_RUNOUT_SLOT]
description: Detekce runoutu v konkrétním slotu MMU (forward compatibility)
params:
  SLOT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    
    M118 "Runout detekován v slotu {slot}"
    
    # Toto makro je volitelné a závisí na konkrétní konfiguraci
    # Typicky by se měl zavolat když motion sensor v daném slotu hlásí runout
    # SLOT zde je již v rozsahu 1-4
    
    {% if printer.print_stats.state == "printing" %}
        {% set current_tool = printer.save_variables.variables.mmu_current_tool|default(-1)|int %}
        
        {% if slot == current_tool %}
            M118 "Runout v AKTIVNÍM slotu {slot} - pokouším se čistit zbýtek"
            _MMU_CONSUME_FILAMENT ITERATIONS=8
            PAUSE REASON="slot{slot}_runout"
        {% else %}
            M118 "Runout v neaktivním slotu {slot} - čekám na výběr"
        {% endif %}
    {% endif %}

# Obsluha zavedení filamentu
[gcode_macro _MMU_INSERT_DETECTED]
description: Filament byl vložen do slotu během nenachystanosti
params:
  SLOT: 1
gcode:
    {% set slot = params.SLOT|default(1)|int %}
    M118 "Detekováno vložení filamentu do slotu {slot}"
    # Lze přidat logiku pro automatické zavedení, pokud není tisk aktivní

# Ověření zavedení filamentu po MMU_CHANGE_TOOL
[gcode_macro _MMU_VERIFY_LOAD]
description: Ověření, zda se filament skutečně zavedl do hlavi
params:
  TIMEOUT: 5
gcode:
    {% set timeout = params.TIMEOUT|default(5)|int %}
    M118 "Ověřuji zavedení filamentu (timeout {timeout}s)..."
    
    G4 P500  # Čekání na stabilizaci
    
    # Otestuj přítomnost filamentu v hlavi pomocí head_switch_sensor
    {% set has_head_sensor = "zmod_ifs_switch_sensor head_switch_sensor" in printer %}
    
    {% if has_head_sensor %}
        # Máme head senzor - kontroluj, že filament je detekován
        {% if not printer["zmod_ifs_switch_sensor head_switch_sensor"].filament_detected %}
            M118 "CHYBA: Filament se nezavedl do hlavi - head_switch_sensor nereaguje!"
            { action_raise_error("Load verification failed: no filament in head") }
        {% endif %}
        M118 "Zavedení ověřeno: filament detekován head_switch_sensor"
        
    {% else %}
        # Senzor není nakonfigurován - pouze log
        M118 "UPOZORNĚNÍ: Ověření zavedení - head_switch_sensor není nakonfigurován"
        M118 "Zavedení ověřeno OK (bez senzoru)"
    {% endif %}

# Ověření vyjmutí filamentu
[gcode_macro _MMU_VERIFY_UNLOAD]
description: Ověření, zda byl filament skutečně vytažen z hlavi
gcode:
    M118 "Ověřuji vyjmutí filamentu..."
    
    G4 P300  # Čekání na stabilizaci
    
    # Otestuj absenci filamentu v hlavi
    {% set has_head_sensor = "zmod_ifs_switch_sensor head_switch_sensor" in printer %}
    
    {% if has_head_sensor %}
        # Máme head sensor - kontroluj, že filament je PRYČ
        {% if printer["zmod_ifs_switch_sensor head_switch_sensor"].filament_detected %}
            M118 "CHYBA: Filament nebyl vytažen - head_switch_sensor stále hlásí přítomnost!"
            { action_raise_error("Unload verification failed: filament still in head") }
        {% endif %}
        M118 "Vyjmutí ověřeno: filament odstraněn (head_switch_sensor potvrzuje)"
        
    {% else %}
        # Senzor není nakonfigurován - pouze log
        M118 "UPOZORNĚNÍ: Ověření vyjmutí - head_switch_sensor není nakonfigurován"
        M118 "Vyjmutí ověřeno OK (bez senzoru)"
    {% endif %}

# Obsluha zbytku filamentu když skončí v IFS
[gcode_macro _MMU_CONSUME_FILAMENT]
description: Využití zbývajícího filamentu v hlavi (POOP - Purge Out Of Purge)
params:
  ITERATIONS: 10
  LENGTH: 10
  SPEED: 100
gcode:
    {% set iterations = params.ITERATIONS|default(10)|int %}
    {% set length = params.LENGTH|default(10)|float %}
    {% set speed = params.SPEED|default(100)|int %}
    
    M118 "Začínám čistit zbývající filament ({iterations}x {length}mm@F{speed})..."
    
    # Disabluj senzor v hlavi, aby se nespustilo PAUSE během čištění
    {% set has_head_sensor = "zmod_ifs_switch_sensor head_switch_sensor" in printer %}
    
    {% if has_head_sensor %}
        SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=0
    {% endif %}
    
    # Iterativní pumping - podobně jako "POOP" v bambufy
    # Každá iterace: dopředu E, zpět -E, krátká pauza
    {% for i in range(iterations) %}
        {% set current_iter = i + 1 %}
        M118 "Čistění filamentu: {current_iter}/{iterations}"
        
        # Dopředu
        G91
        G0 E{length} F{speed}
        G4 P100  # Pauza aby se filament vytlačil ven
        
        # Zpět (vytáhni to co nešlo ven)
        G0 E-{length} F{speed}
        G90
        
        # Čekání mezi iteracemi (může se oteplat/stabilizovat)
        G4 P200
        
        # Kontrola: je už filament pryč?
        {% if has_head_sensor %}
            {% if not printer["zmod_ifs_switch_sensor head_switch_sensor"].filament_detected %}
                M118 "Filament detekován jako vyvíjený v iteraci {current_iter}"
                {% break %}
            {% endif %}
        {% endif %}
    {% endfor %}
    
    M118 "Čistění filamentu dokončeno"
    
    # Znovu povoluj senzor
    {% if has_head_sensor %}
        SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
    {% endif %}

################################################################################
# 9. ROZŠÍŘENÁ OBSLUHA SENZORŮ V MMUU_CHANGE_TOOL
################################################################################

# Aktualizuj MMU_CHANGE_TOOL s ověřením filamentu
# (Toto bude integrováno do stávajícího MMU_CHANGE_TOOL makra)

################################################################################
# 10. DOKUMENTACE INTEGROVANÝCH IFS PŘÍKAZŮ
################################################################################

# Tento konfigurační soubor integruje následující příkazy z IFS kontroléru:
#
# ============================================================================
# PŘÍKAZY IFS KONTROLÉRU - Základní operace
# ============================================================================
#
# 1. IFS_F10 - Insert filament
#    Zavedení filamentu do IFS systému
#    Wrapper: _MMU_INSERT_FILAMENT SLOT=0 LEN=90 SPEED=1200 WAIT=1 CHECK=0 SLEEP=0
#
# 2. IFS_F11 - Remove filament
#    Vytažení filamentu z IFS systému
#    Wrapper: _MMU_REMOVE_FILAMENT SLOT=0 LEN=90 SPEED=1200 WAIT=1 CHECK=0
#
# 3. IFS_F13 - IFS state
#    Zjištění aktuálního stavu IFS jednotky
#    Wrapper: _MMU_GET_STATUS
#
# 4. IFS_F15 - Reset driver
#    Reset řídící jednotky IFS (při chybě)
#    Wrapper: _MMU_DRIVER_RESET
#
# 5. IFS_F18 - Filament purge everywhere
#    Čistění filamentu v celé IFS (všechny sloty)
#    Wrapper: _MMU_PURGE_ALL WAIT=1
#
# 6. IFS_F23 - Mark filament as inserted
#    Označení filamentu jako zavědeného v IFS
#    Wrapper: _MMU_MARK_INSERTED SLOT=0 WAIT=1
#
# 7. IFS_F24 - Filament clamp
#    Upnutí/sevření filamentu v IFS
#    Wrapper: _MMU_FILAMENT_CLAMP SLOT=0 WAIT=1
#
# 8. IFS_F39 - Filament purge
#    Čistění filamentu v určité zóně IFS
#    Wrapper: _MMU_FILAMENT_PURGE SLOT=0 WAIT=1
#
# 9. IFS_F112 - Stop filament feed
#    Zastavení podávání filamentu
#    Wrapper: _MMU_STOP_FEED WAIT=0
#
# ============================================================================
# DETAILNÍ DOKUMENTACE PARAMETRŮ
# ============================================================================
# Viz IFS_COMMANDS.md pro kompletní dokumentaci všech parametrů a příklady!
#
# Všechna wrapper makra nyní podporují přímé předávání parametrů z IFS:
# - LEN: délka vedení/vytažení (mm)
# - SPEED: rychlost operace (mm/min)
# - WAIT: čekat na dokončení (0/1)
# - CHECK: kontrolovat operaci (0/1)
# - PRUTOK: číslo portu (1-4)
# - Další specifické parametry dle typu operace
#
# ============================================================================
# PŘÍKAZY PRO SPRÁVU FILAMENTU - Vyšší úroveň
# ============================================================================
#
# 1. PURGE_PRUTOK_IFS
#    Čistění filamentu z IFS do extruderu
#    Wrapper: _MMU_PURGE_TO_EXTRUDER [LENGTH=100]
#
# 2. REMOVE_PRUTOK_IFS
#    Odstranění filamentu z konkrétního slotu
#    Wrapper: _MMU_REMOVE_BY_SLOT [SLOT=1-4]
#
# 3. INSERT_PRUTOK_IFS
#    Zavedení filamentu z konkrétního slotu
#    Wrapper: _MMU_INSERT_BY_SLOT [SLOT=1-4]
#
# 4. SET_CURRENT_PRUTOK
#    Nastavení aktivního filamentu v Klipperu
#    Wrapper: _MMU_SET_CURRENT_TOOL [SLOT=1-4]
#
# 5. ANALOG_PRUTOK
#    Načtení analogického (ekvivalentního) filamentu
#    Wrapper: _MMU_LOAD_ANALOG_ROD
#
# 6. IFS_MOTION
#    Kontrola pohybu/detekce konca filamentu
#    Wrapper: _MMU_CHECK_MOTION
#
# ============================================================================
# MAKRA PRO KONEČNÉ UŽIVATELE
# ============================================================================
#
# T0, T1, T2, T3
#    Výběr nástrojů (filamentů)
#    Příklad: T0 (vybere filament ze slotu odpovídajícího indexu 0 -> filament 1)
#
# START_PRINT [INITIAL_TOOL=1] [NOZZLE_TEMP=200] [BED_TEMP=60]
#    Příprava tiskárny - inicializace MMU a zavedení prvního filamentu
#    Příklad: START_PRINT INITIAL_TOOL=1 NOZZLE_TEMP=220 BED_TEMP=70
#
# MMU_CHANGE_TOOL TOOL=1-4
#    Výměna filamentu mezi sloty (čtyři fáze: Unload, Select, Load, Verify)
#    Příklad: MMU_CHANGE_TOOL TOOL=2
#
# MMU_STATUS
#    Zobrazení aktuálního stavu MMU a IFS
#
# MMU_RESET
#    Reset stavů MMU a resetování IFS jednotky
#
# MMU_ENABLE / MMU_DISABLE
#    Povolení/zakázání MMU
#
# MMU_EMERGENCY_STOP
#    Nouzové zastavení - vypnutí všech pohonů filamentu
#
# MMU_PURGE_FILAMENT
#    Čistění filamentu v celé IFS
#
# ============================================================================
# TOK VÝMĚNY FILAMENTU
# ============================================================================
#
# Při zavolání T0-T3 nebo MMU_CHANGE_TOOL:
#
# 1. UNLOAD (Vytažení)
#    - Kontrola, zda hlava obsahuje filament
#    - Retrakt (-20mm)
#    - Snížení teploty o 30°C (anti-ooze režim)
#    - Zavolání REMOVE_PRUTOK_IFS pro vytažení z IFS
#
# 2. SELECT (Výběr)
#    - Zavolání INSERT_PRUTOK_IFS pro vybrání správného slotu
#
# 3. LOAD (Zavedení)
#    - Start zahřívání na cílovou teplotu (M104 - neblokující)
#    - Zavolání PURGE_PRUTOK_IFS pro čistění do extruderu
#    - Čekání na dosažení teploty (M109 - blokující)
#    - Označení filamentu jako zavědeného (IFS_F23)
#    - Kontrola pohybu filamentu (IFS_MOTION)
#
# 4. VERIFY (Ověření)
#    - Uložení aktuálního nástroje
#    - Nastavení aktuálního filamentu v Klipperu
#
# ============================================================================
# BEZPEČNOSTNÍ FUNKCE
# ============================================================================
#
# - Validace čísla slotu (1-4)
# - Kontrola, zda je MMU povolena
# - Detektor duplicitní výměny (stejný nástroj = bez akce)
# - Anti-ooze teplotní režim během výměny
# - Kontrola pohybu filamentu v extruderu
# - Timeout pro IFS příkazy (ošetření zaseknutí)
#
# ============================================================================
# PŘÍKLAD POUŽITÍ V G-KODU
# ============================================================================
#
# ; Tisky s více materiály
# G28  ; Domů
# START_PRINT INITIAL_TOOL=1 NOZZLE_TEMP=220 BED_TEMP=70
# 
# ; Tiskový kód (vrstva 1 - filament 1)
# G1 X0 Y0 Z0.2 F3000
# G1 X10 Y10 E10 F1000
#
# ; Výměna filamentu
# T2  ; Přepnutí na filament 2
#
# ; Tiskový kód (vrstva 2 - filament 2)
# G1 X20 Y20 Z0.4 F3000
# G1 X30 Y30 E10 F1000
#
# ; Konec tisku
# M104 S0  ; Vypnout teplotu
# M140 S0  ; Vypnout tisk. plochu
